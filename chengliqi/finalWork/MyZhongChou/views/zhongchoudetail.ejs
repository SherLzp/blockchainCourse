**<!DOCTYPE html>
<html>
  <head>
    <title>ZhongChouDApp</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="/stylesheets/main.css"/>
    <link rel='stylesheet' href="/bootstrap/css/bootstrap.min.css"/>
    <link rel="stylesheet" href="/stylesheets/intro.css"/>
    <link rel="shortcut icon" href="#"/>
    <script src="/jquery/jquery.js"></script>
    <script src="/bootstrap/js/bootstrap.min.js"></script>
    <script src="/javascripts/intro.js"></script>
    
    <style>
      body{
        background: url(images/bgm.png) no-repeat center center;
        background-size: cover; 
      }
      h3{
          text-align: center;
          margin-bottom: 25px;
      }
    </style>
  </head>
    <body>
        
        <div class="container">
            <div class="clqintro">
                <div class="col-md-offset-1 col-md-10">
                    <div class="intro_block">
                        <h3>众筹详情<button type="button"style="float:right" class="btn btn-danger" onclick="backall()">关闭</button></h3>  
                        <div id="myCarousel" class="carousel slide">
                            <!-- 轮播（Carousel）指标 -->
                            <ol class="carousel-indicators">
                                <li data-target="#myCarousel" data-slide-to="0" class="active"></li>
                                <li data-target="#myCarousel" data-slide-to="1"></li>
                                <li data-target="#myCarousel" data-slide-to="2"></li>
                            </ol>   
                            <!-- 轮播（Carousel）项目 -->
                            <div class="carousel-inner">
                                <div class="item active" onclick="goto1()">
                                    <img src="/images/1.jpg" alt="First slide">
                                </div>
                                <div class="item" onclick="goto2()">
                                    <img src="/images/2.jpg" alt="Second slide">
                                </div>
                                <div class="item" onclick="goto3()">
                                    <img src="/images/3.jpg" alt="Third slide">
                                </div>* *                     </div>
                            <!-- 轮播（Carousel）导航 -->
                            <a class="carousel-control left" href="#myCarousel" 
                               data-slide="prev"> <span _ngcontent-c3="" aria-hidden="true" class="glyphicon glyphicon-chevron-right"></span></a>
                            <a class="carousel-control right" href="#myCarousel" 
                               data-slide="next">&rsaquo;</a>
                        </div>                     
                        <hr>
                        <div class="row">
                            <div class="col-md-12">
                                <div style="padding-left:50px;">
                                    <div class="panel panel-default">
                                        <div class="panel-heading">
                                            <h4 class="panel-title">
                                                <a data-toggle="collapse" data-parent="#accordion" 
                                                href="#collapseOne1">
                                                项目基本信息
                                                </a>
                                            </h4>
                                        </div>
                                        <div id="collapseOne1" class="panel-collapse collapse in">
                                            <div class="panel-body">
                                                <div id="content4">                                               
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>众筹名称</th>
                                                                <th>发起人</th>
                                                                <th>所有人</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                           **                 <tr>
                                                               <td><%= funding.name %></td> 
                                                               <td><%= funding.creator %></td> 
                                                               <td>程礼棋</td> 
                                                            </tr>  
                                                        </tbody>
                                                    </table>
                                                    <table class="table table-hover">
                                                        <thead>
                                                            <tr>
                                                                <th>众筹进度</th>
                                                                <th>项目余额</th>
                                                                <th>众筹状态</th>
                                                                <th>截止时间</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody>
                                                            <tr>
                                                               <td><%= funding.present %>/<%= funding.target %></td> 
                                                               <td><% if(privilege != 0){ %>
                                                                <div>
                                                                    <p><%= funding.balance %> eth</p>
                                                                </div></td>
                                                            <% } %>  
                                                               <td> <% if(funding.status == 1 ){ %>
                                                                        已达标
                                                                    <% } else if(funding.status == 0) { %>
                                                                        未达标
                                                                    <% } else if (funding.status == -1) { %>
                                                                        已失败
                                                                    <% } %>
                                                                </td> 
                                                               <td><%= funding.endTime %></td>
                                                            </tr>  
                                                        </tbody>
                                                    </table>
                                                    <div class="progress progress-striped active">
                                                        <div class="progress-bar progress-bar-success" style="width: 100%;" role="progressbar" aria-valuenow="25" aria-valuemin="0" aria-valuemax="100"><%= funding.present / funding.target*100%> %</div>
                                                    </div>     
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <p>&nbsp</p>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div style="padding-left:50px;">
                                <div class="panel panel-default">
                                    <div class="panel-heading">
                                        <h4 class="panel-title">
                                            <a data-toggle="collapse" data-parent="#accordion" 
                                            href="#collapseOne2">
                                            参与此众筹的人
                                            </a>
                                        </h4>
                                    </div>
                                    <div id="collapseOne2" class="panel-collapse collapse in">
                                        <div class="panel-body">
                                            <div id="content5">                                               
                                                <table class="table table-hover">
                                                    <thead>
                                                        <tr>
                                                            <th>捐款人</th>
                                                            <th>捐款金额(ETH)</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <% for(let i = 0;i<funding.investors.length;i++){ %>
                                                        <tr>
                                                           <td><%= funding.investors[i] %></td> 
                                                           <td><%= funding.support[i] %></td> 
                                                        </tr> 
                                                        <% } %> 
                                                    </tbody>
                                                </table> 
                                            </div>
                                        </div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <p>&nbsp</p>
                        </div>
                        <div class="row">
                            <div class="col-md-12">
                                <div style="padding-left:50px;padding-right:50px">
                                    <div>
                                        <h4><b>当前需求</b></h4>
                                    </div>
                                    <% if(privilege == 0){ %>
                                        <div><p>您无权查看</p></div>
                                    <% }else { %>
                                        <table class="table table-hover">
                                                <thead>
                                                    <tr>
                                                        <th>需求说明</th>
                                                        <th>资助目标</th>
                                                        <th>资助金额(ETH)</th>
                                                        <th>支持股权</th>
                                                        <th>目前状态</th>
                                                    </tr>
                                                </thead>                                         
                                                <tbody>
                                                    <% for(let i = 0;i<funding.requests.length;i++){ %>
                                                        <% let request = funding.requests[i] %>
                                                    <tr>
                                                       <td><%= request.purpose %></td> 
                                                       <td><%= request.seller %></td> 
                                                       <td><%= request.cost %>eth</td>
                                                        <td><% if(privilege != 0 && request.status == 0){ %>
                                                            <p><%= request.count %>/<%= funding.target %></p>
                                                        <% } %>
                                                        </td> 
                                                        <td><% if(privilege == 2 && request.status == 0){ %>
                                                            <p>等待投票</p>
                                                            <% } else if(privilege != 0 && request.status == 2){ %>
                                                            <p>已完成</p>
                                                            <% } else { %>
                                                                <p>已废弃</p>
                                                        <% } %>
                                                        </td> 
                                                    </tr>
                                                    <% } %> 
                                                </tbody>
                                            </table> 
                                            <div class="panel panel-default">
                                                <div class="panel-heading">
                                                    <h4 class="panel-title">
                                                        <a data-toggle="collapse" data-parent="#accordion" 
                                                        href="#collapseOne56">
                                                        请求状态及待执行功能
                                                        </a>
                                                    </h4>
                                                </div>
                                                <div id="collapseOne56" class="panel-collapse collapse in">
                                                    <div class="panel-body">
                                                        <table class="table table-hover">
                                                            <thead>
                                                                <tr>
                                                                    <th>需求说明</th>
                                                                    <th>执行功能</th>
                                                                </tr>
                                                            </thead>                                         
                                                            <tbody>
                                                                <% for(let i = 0;i<funding.requests.length;i++){ %>
                                                                    <% let request = funding.requests[i] %>
                                                                <tr>
                                                                    <td><%= request.purpose %></td> 
                                                                    <td>
                                                                        <% if(privilege == 2 && request.status == 0){ %>
                                                                            <button class="btn btn-default"  onclick="approve_request(<%= i %>)"><span class="glyphicon glyphicon-plus"
                                                                                aria-hidden="true"></span>同意</button>
                                                                            <button class="btn btn-default"  onclick="deny_request(<%= i %>)"><span class="glyphicon glyphicon-plus"
                                                                                aria-hidden="true"></span>拒绝</button>
                                                                    <% } else if (privilege == 2 && request.status == 1){ %>
                                                                        <p>已获大多数同意，等待执行</p>
                                                                    <% } else if (privilege != 0 && request.status == 2){ %>
                                                                        <p>已完成</p>
                                                                    <% } else if(privilege == 1 && request.status == 1){ %>
                                                                        <button class="btn btn-default"  onclick="execute_request(<%= i %>)"><span class="glyphicon glyphicon-plus"
                                                                            aria-hidden="true"></span>执行</button>
                                                                    <% } %>
                                                                    </td>
                                                                </tr>
                                                                <% } %>
                                                            </tbody>
                                                        </table> 
                                                    </div>
                                                </div>
                                            </div>
                                       
                                        <% if(privilege == 1 && funding.status == 1){ %>
                                            <div class="alert alert-success">
                                                <button type="button" class="close" data-dismiss="alert"
                                                    aria-hidden="true">
                                                    &times;
                                                    
                                                </button>
                                                <h3>成功！完成了筹钱！请创建使用筹金请求</h3>
                                            </div>
                                            <button class="btn btn-success"  onclick="show_modal()"><span class="glyphicon glyphicon-plus"
                                                        aria-hidden="true"></span>创建请求</button>
                                        <% } %>
                                    <% } %>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <p>&nbsp</p>
                        </div>
                        <hr>
                    </div>
                </div>
            </div>
        </div>
        <div class="modal fade" id="modal_add_request" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-hidden="true">
                            &times;
                        </button>
                        <h4 class="modal-title" id="myModalLabel">
                            需求请求单
                        </h4>
                    </div>
                    <div class="modal-body">
                        <div class="input-group" style="margin-top: 2%;">
                            <span class="input-group-addon">需求说明</span>
                            <input type="text" name="purpose" class="form-control" placeholder="需求说明">
                        </div>
                        <div class="input-group" style="margin-top: 2%;">
                            <span class="input-group-addon">资助用户ID</span>
                            <select name="seller">
                                <% for (let i = 0; i < users.length; i++) { %>
                                    <option value="<%= users[i] %>"><img class="ui mini avatar image" src="/images/metamask.png"><%= users[i] %></option>
                                <% } %>
                            </select>
                        </div>
                        <div class="input-group" style="margin-top: 2%;">
                            <span class="input-group-addon">资助用户详细说明</span>
                            <input type="text" name="profileperson" class="form-control" placeholder="简略说明被资助人情况">
                        </div>
                        <div class="input-group" style="margin-top: 2%;">
                            <span class="input-group-addon">花费金额</span>
                            <input type="text" name="cost" class="form-control" placeholder="ETH">
                        </div> 
                        <div class="checkbox" style="font-size: 17px;">
                            <label><input type="checkbox">核实信息后确认打勾</label>
                        </div>
                        <div class="active section"> <a href=" https://github.com/liamclq/">发布需求指南及须知</a></div>
                        <div class="field"><h3>当前筹金余额： <span class="label label-default"><%= funding.balance %>ETH</span></h3></div>
         
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-danger" data-dismiss="modal">关闭
                        </button>
                        <button type="button" class="btn btn-success" onclick="create_request()">
                            提交
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </body>
    <script>
        /**
     * @param userName 用户名
     * @param password 用户密码
     * @return 登陆成功返回用户ID，登陆失败返回null
     * @throws SQLException
     */
    function show_modal(){
        $('#modal_add_request').modal('show');
    }
    function create_request(){
        $.ajax({
            dataType: "json",
            type: "post",
            url: "/createRequest",
            data: {
                funding_addr:'<%= funding.address %>',
                purpose: $("input[name='purpose']").val(),
                seller: $("select[name='seller']").val(),
                cost: $("input[name='cost']").val(),
            },
            success: (data) => {
                if (data.status == 1) {
                alert("新建成功！");
                window.location.reload();
                } else alert(data.msg);
            },
            error: (err) => {
                alert("与服务器连接异常，请稍后再试!");
            },
        });
    }
    function execute_request(index){
        let addr = '<%= funding.address %>';
        $.ajax({
            dataType: "json",
            type: "post",
            url: "/executeRequest",
            data: {
                address: addr,
                index:index
            },
            success: (data) => {
                if (data.status == 1) {
                    alert("执行成功！");
                    window.location.reload();
                } else{
                    alert("执行失败！");
                    console.log(data.msg);
                }
            },
            error: (err) => {
                alert("与服务器连接异常，请稍后再试!");
            },
        });
    }
    function approve_request(index){
        let addr = '<%= funding.address %>';
        $.ajax({
            dataType: "json",
            type: "post",
            url: "/approveRequest",
            data: {
                address: addr,
                index: index
            },
            success: (data) => {
                if (data.status == 1) {
                    alert("成功同意")
                    window.location.reload();
                } else{
                    alert("已经同意过本请求");
                }
            },
            error: (err) => {
                alert("与服务器连接异常，请稍后再试!");
            },
        });
    }
    function deny_request(index){
        let addr = '<%= funding.address %>';
        $.ajax({
            dataType: "json",
            type: "post",
            url: "/denyRequest",
            data: {
                address: addr,
                index: index
            },
            success: (data) => {
                if (data.status == 1) {
                    alert("拒绝成功")
                    window.location.reload();
                } else{
                    alert("已经拒绝过本请求");
                }
            },
            error: (err) => {
                alert("与服务器连接异常，请稍后再试!");
            },
        });
    }
    function backall(){
        window.location.href = "/Home";
    }
    function goto1(){
        window.location.href = "https://izhongchou.taobao.com/dreamdetail.htm?spm=a215p.1596646.0.0.107f47dbJZfRMD&id=20095870";
    }
    function goto2(){
        window.location.href = "https://izhongchou.taobao.com/dreamdetail.htm?spm=a215p.1596646.0.0.107f47dbJZfRMD&id=20096028";
    }
    function goto3(){
        window.location.href = "https://izhongchou.taobao.com/dreamdetail.htm?spm=a215p.1596646.0.0.107f47dbJZfRMD&id=20095655";
    }
    </script>
</html>